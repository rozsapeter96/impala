====
---- QUERY
# Failing implicit string to hour cast
alter table iceberg_all_partitions drop partition (hour(hour_timestamp) = "2012-12-12");
---- CATCH
AnalysisException: operands of type INT and STRING are not comparable: HOUR(hour_timestamp) = '2012-12-12'
====
---- QUERY
# Failing implicit string to day cast
alter table iceberg_all_partitions drop partition (day(day_date) = "2012-12");
---- CATCH
AnalysisException: operands of type INT and STRING are not comparable: DAY(day_date) = '2012-12'
====
---- QUERY
# Failing implicit string to month cast
alter table iceberg_all_partitions drop partition (month(month_date) = "2012");
---- CATCH
AnalysisException: operands of type INT and STRING are not comparable: MONTH(month_date) = '2012'
====
---- QUERY
# Failing implicit string to year cast
alter table iceberg_all_partitions drop partition (year(year_date) = "2012-12-12-20");
---- CATCH
AnalysisException: operands of type INT and STRING are not comparable: YEAR(year_date) = '2012-12-12-20'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_boolean) values (true);
ALTER TABLE iceberg_all_partitions DROP PARTITION(identity_boolean = true)
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_int) values (1);
ALTER TABLE iceberg_all_partitions DROP PARTITION(identity_int = 1)
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_bigint) values (1);
ALTER TABLE iceberg_all_partitions DROP PARTITION(identity_bigint = 1)
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_float) values (1.0);
ALTER TABLE iceberg_all_partitions DROP PARTITION(identity_float < 3.0)
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_double) values (1.0);
ALTER TABLE iceberg_all_partitions DROP PARTITION(identity_double > 0.0)
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_decimal) values (1);
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity_decimal < 3);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_date) values ('2000-12-12');
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity_date = '2000-12-12');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_string) values ("string");
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity_string = "string");
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_string) values ("string");
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity(identity_string) = "string");
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_string) values ("string"), ("another-string");
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity(identity_string) = "string");
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity(identity_string) = "another-string");
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_string) values ("string"), ("another-string");
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity(identity_string) = "string");
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(bucket_int) values (100), (200);
ALTER TABLE iceberg_all_partitions DROP PARTITION (bucket(5, bucket_int) = 1);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(bucket_bigint) values (100);
ALTER TABLE iceberg_all_partitions DROP PARTITION (bucket(5, bucket_bigint) = 1);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(bucket_decimal) values (10);
ALTER TABLE iceberg_all_partitions DROP PARTITION (bucket(5, bucket_decimal) = 3);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(bucket_date) values ("1526-01-12");
ALTER TABLE iceberg_all_partitions DROP PARTITION (bucket(5, bucket_date) = 0);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(bucket_timestamp) values ("1583-04-02 03:00:00");
ALTER TABLE iceberg_all_partitions DROP PARTITION (bucket(5, bucket_timestamp) = 1);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(bucket_string) values ("string");
ALTER TABLE iceberg_all_partitions DROP PARTITION (bucket(5, bucket_string) = 1);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(truncate_int) values (131072);
ALTER TABLE iceberg_all_partitions DROP PARTITION (truncate(5, truncate_int) = 131070);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(truncate_bigint) values (68719476736);
ALTER TABLE iceberg_all_partitions DROP PARTITION (truncate(5, truncate_bigint) = 68719476735);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(truncate_decimal) values (100000.1234567891);
ALTER TABLE iceberg_all_partitions DROP PARTITION (truncate(5, truncate_decimal) = 100000.1234567890);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(truncate_string) values ('thisisalongstring');
ALTER TABLE iceberg_all_partitions DROP PARTITION (truncate(5, truncate_string) = 'thisi');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(year_date) values ('2077-05-06');
ALTER TABLE iceberg_all_partitions DROP PARTITION (year(year_date) = '2077');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(month_date) values ('2023-12-01');
ALTER TABLE iceberg_all_partitions DROP PARTITION (month(month_date) = '2023-12');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(day_date) values ('2023-12-01');
ALTER TABLE iceberg_all_partitions DROP PARTITION (day(day_date) = '2023-12-01');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(year_timestamp) values ('2023-12-02 00:00:00');
ALTER TABLE iceberg_all_partitions DROP PARTITION (year(year_timestamp) = '2023');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(month_timestamp) values ('2023-12-02 00:00:00');
ALTER TABLE iceberg_all_partitions DROP PARTITION (month(month_timestamp) = '2023-12');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(day_timestamp) values ('2023-03-02 00:00:00');
ALTER TABLE iceberg_all_partitions DROP PARTITION (day(day_timestamp) = '2023-03-02');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(hour_timestamp) values ('2023-03-02 00:00:00');
ALTER TABLE iceberg_all_partitions DROP PARTITION (hour(hour_timestamp) = '2023-03-02-0');
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_all_partitions(identity_string, hour_timestamp) values
('string','2023-03-02 00:00:00'),
('another-string', '2023-03-02 00:00:00'),
('another-string', '2023-03-02 10:00:00'),
('string', '2023-03-02 10:00:00');
ALTER TABLE iceberg_all_partitions DROP PARTITION (identity_string in ('string', 'another-string') and hour(hour_timestamp) = '2023-03-02-10');
---- RESULTS
'Dropped 2 partition(s)'
====
---- QUERY
ALTER TABLE iceberg_all_partitions DROP PARTITION (hour(hour_timestamp) < '2030-03-02-10' );
---- RESULTS
'Dropped 2 partition(s)'
====
---- QUERY
# Partition evolution
CREATE TABLE iceberg_drop_partition_evolution(identity_int int, unpartitioned_int_to_identity_int int)
PARTITIONED BY SPEC(identity(identity_int)) STORED AS ICEBERG;
INSERT INTO iceberg_drop_partition_evolution(identity_int, unpartitioned_int_to_identity_int)
VALUES (1, 2);
ALTER TABLE iceberg_drop_partition_evolution
SET PARTITION SPEC(identity(identity_int), identity(unpartitioned_int_to_identity_int));
INSERT INTO iceberg_drop_partition_evolution(identity_int, unpartitioned_int_to_identity_int)
VALUES (1, 2);
ALTER TABLE iceberg_drop_partition_evolution DROP PARTITION (unpartitioned_int_to_identity_int = 2);
---- RESULTS
'Dropped 1 partition(s)'
====
---- QUERY
INSERT INTO iceberg_drop_partition_evolution(identity_int, unpartitioned_int_to_identity_int)
VALUES (1, 2);
ALTER TABLE iceberg_drop_partition_evolution SET PARTITION SPEC(identity(identity_int));
ALTER TABLE iceberg_drop_partition_evolution DROP PARTITION (unpartitioned_int_to_identity_int = 2);
---- CATCH
AnalysisException: Partition exprs cannot contain non-partition column(s): unpartitioned_int_to_identity_int
====
---- QUERY
# Dropping delete files
CREATE TABLE iceberg_drop_partition_delete(identity_int int, unpartitioned_int int)
PARTITIONED BY SPEC (identity_int) STORED AS ICEBERG TBLPROPERTIES('format-version'='2');
INSERT INTO iceberg_drop_partition_delete values(1,2);
INSERT INTO iceberg_drop_partition_delete values(2,1);
DELETE FROM iceberg_drop_partition_delete where identity_int = 1;
ALTER TABLE iceberg_drop_partition_delete DROP PARTITION (identity_int = 1);
SHOW FILES IN iceberg_drop_partition_delete;
---- RESULTS
row_regex:'$NAMENODE/test-warehouse/$DATABASE.db/iceberg_drop_partition_delete/data/identity_int=2/.*_data.*.parq','.*','','$ERASURECODE_POLICY'
---- TYPES
STRING, STRING, STRING, STRING
====



